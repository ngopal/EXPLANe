<!DOCTYPE html>
<!--
    Copyright (c) 2012-2014 Adobe Systems Incorporated. All rights reserved.

    Licensed to the Apache Software Foundation (ASF) under one
    or more contributor license agreements.  See the NOTICE file
    distributed with this work for additional information
    regarding copyright ownership.  The ASF licenses this file
    to you under the Apache License, Version 2.0 (the
    "License"); you may not use this file except in compliance
    with the License.  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing,
    software distributed under the License is distributed on an
    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
     KIND, either express or implied.  See the License for the
    specific language governing permissions and limitations
    under the License.
-->
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="format-detection" content="telephone=no" />
        <meta name="msapplication-tap-highlight" content="no" />
        <!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />
        <link rel="stylesheet" type="text/css" href="css/index.css" />
        <title>EXPLANe</title>
    </head>
    <body>
        <div class="app">
            <div class="appTitle">EXPLANe</div>
            <div id="deviceready" class="blink">
                <p class="event listening">Status: Preparing Device</p>
                <p class="event received">Status: Ready</p>
                <br>
            </div>
            <div id="uploadarea">
                <input class="myVarButton" id="startCamera" type="submit" value="Select Poster from Library for Processing" />
                <br>
                <input class="myVarButton" id="takePicture" type="submit" value="Take Photo of Poster and Process" />
                <br>
                <!-- <img id="canvas" /> -->
            </div>
            <div id="variantResults">
                <br><br>
                <div id="tabs">
                    <ul class="tabrow">
                        <li id="geneticsItem" class="selected" onclick="serveGeneticsTab()">Genetics</li>
                        <li id="urlsItem" onclick="serveURLTab()">URLs</li>
                        <li id="yourItem" onclick="serveYourTab()">Your Tab Here</li>
                    </ul><br>
                </div>
                <div id="geneticsTab">
                    <h2 id="resultsTitle">No variants were found</h2>
                </div>
                <div id="urlsTab">
                    <div id="urlsTabStartMessage">
                        This tab could present a number of URLs extracted from a poster!
                    </div>
                </div>
                <div id="yourTab">
                    As a developer, you may customize your own tab.
                </div>
            </div>
        </div>
        <script type="text/javascript" src="cordova.js"></script>
        <script type="text/javascript" src="js/index.js"></script>
        <script type="text/javascript" src="js/node_modules/d3/d3.min.js"></script>
        <access origin="*" />
        <script type="text/javascript">
            //$.support.cors = true;


        function serveURLTab() {
            document.getElementById("geneticsTab").style.display = "none";
            document.getElementById("urlsTab").style.display = "inline";
            document.getElementById("yourTab").style.display = "none";

            document.getElementById("geneticsItem").classList.remove('selected');
            document.getElementById("yourItem").classList.remove('selected');
            document.getElementById("urlsItem").className = "selected";
        }

        function serveGeneticsTab() {
            document.getElementById("geneticsTab").style.display = "inline";
            document.getElementById("urlsTab").style.display = "none";
            document.getElementById("yourTab").style.display = "none";

            document.getElementById("urlsItem").classList.remove('selected');
            document.getElementById("yourItem").classList.remove('selected');
            document.getElementById("geneticsItem").className = "selected";
        }

        function serveYourTab() {
            document.getElementById("yourTab").style.display = "inline";
            document.getElementById("geneticsTab").style.display = "none";
            document.getElementById("urlsTab").style.display = "none";

            document.getElementById("urlsItem").classList.remove('selected');
            document.getElementById("geneticsItem").classList.remove('selected');
            document.getElementById("yourItem").className = "selected";
        }

        function initializeTabs() {
            document.getElementById("geneticsTab").style.display = "inline";
            document.getElementById("urlsTab").style.display = "none";
            document.getElementById("yourTab").style.display = "none";

            document.getElementById("startCamera").style.height = window.innerHeight*0.10 + "px";
            document.getElementById("startCamera").style.borderRadius = "0px";
            document.getElementById("takePicture").style.height = window.innerHeight*0.10 + "px";
            document.getElementById("takePicture").style.borderRadius = "0px";
        }

        app.initialize();
        initializeTabs();


        function init() {
            document.querySelector("#startCamera")
                    .addEventListener("touchend", startCamera, false);
        }

        document.addEventListener("deviceready", init, false);
        var myVariantUrl = "http://myvariant.info/v1/query?q=";
        var cameraPopoverHandle;

        function onSuccess(u) {
            // imageUpload(u);
            document.getElementsByClassName("event received")[0].innerHTML = "Status: Uploading"
            var options = new FileUploadOptions();
            options.fileKey = "file";
            options.fileName = u.substr(u.lastIndexOf('/') + 1);
            options.mimeType = "image/jpeg";
            options.enctype = "multipart/form-data";
            // options.headers = {
            //     Connection: "close"
            // };
            options.chunkedMode = true;
            options.httpMethod = "POST";
            var trustAllHosts = true;
            var ft = new FileTransfer();
            ft.upload(u, 
                    //encodeURI("http://localhost:3001/api/photo"),
                    encodeURI("http://warm-depths-7622.herokuapp.com/api/photo"), 
                    win, 
                    fail, 
                    options, 
                    trustAllHosts);
        }

        function onFail(e) {
            navigator.notification.alert(
                'You exited without taking or selecting a picture!',
                function() { return null;},
                "EXPLANe",
                "OKAY"
            );
            console.log(e);
        }

        function startCamera() {

            cameraPopoverHandle = navigator.camera.getPicture(onSuccess, onFail,
             { destinationType: Camera.DestinationType.FILE_URI,
               sourceType: Camera.PictureSourceType.PHOTOLIBRARY,
               popoverOptions: new CameraPopoverOptions(300, 300, 200, 200, Camera.PopoverArrowDirection.ARROW_ANY)
             });

        }

        function updateUserOnRequestSent() {
            console.log("Sent to server");
            //document.getElementById(".received").textContent="Sending File and Awaiting Reply";
        }

        function updateUserOnRequestReceived() {
            console.log("Reply received from server");
            //document.querySelector(".event.received").write("Analysis Complete")
        }

        function takePicture() {

            cameraPopoverHandle = navigator.camera.getPicture(onSuccess, onFail,
             { destinationType: Camera.DestinationType.FILE_URI,
               sourceType: Camera.PictureSourceType.CAMERA,
               //popoverOptions: new CameraPopoverOptions(300, 300, 200, 200, Camera.PopoverArrowDirection.ARROW_ANY)
             });

        }

         // Reposition the popover if the orientation changes.
         window.onorientationchange = function() {
            console.log('running onorientationchange');
            var cameraPopoverOptions = new CameraPopoverOptions(0, 0, 100, 100, Camera.PopoverArrowDirection.ARROW_ANY);
            cameraPopoverHandle.setPosition(cameraPopoverOptions);
         }
            

        

        function imageUpload(url) {
                console.log('onSuccess');
                //alert("url "+JSON.stringify(url));
                var options = new FileUploadOptions();
                options.fileKey = "file";
                options.fileName = url.substr(url.lastIndexOf('/') + 1);
                options.mimeType = "image/jpeg";
                options.enctype = "multipart/form-data";
                options.headers = {
                    Connection: "close"
                };
                options.chunkedMode = true;
                options.httpMethod = "POST";

                var trustAllHosts = true;
                //alert("options "+JSON.stringify(options));

                var ft = new FileTransfer();
                //alert("About to send upload command");
                updateUserOnRequestSent();
                ft.upload(url, 
                    //encodeURI("http://localhost:3001/api/photo"),
                    encodeURI("http://warm-depths-7622.herokuapp.com/api/photo"), 
                    win, 
                    fail, 
                    options, 
                    trustAllHosts);
            }

        function win(r) {
                //alert("r "+JSON.stringify(r));
                //alert("Code = " + r.responseCode
                //+ " Response = " + r.response
                //+ " Sent = " + r.bytesSent);
                //document.querySelector("#variantItems p").write("RESPONDED");
                //alert(r.response);
                //updateUserOnRequestReceived();
                document.getElementsByClassName("event received")[0].innerHTML = "Status: Received Response";
                var responseObject = JSON.parse(r.response);

                responseObject.url = "http://www.google.com,http://nikhilgopal.com";

                if (responseObject.url.length === 0) {
                   alert("No URLs found in poster");
                }
                else {
                    // Populate urls tab
                    MakeUrlList(responseObject.url);
                }

                if (responseObject.rsid.length === 0) {
                    alert("No RSIDs found in poster");
                }
                else {
                    // Populate the genetics tab with myvariant information
                    d3.json(myVariantUrl.concat(responseObject.rsid), function(d3err, d3data) {
                        if(d3err != null) {
                            //alert("d3ERR", JSON.stringify(d3err));
                            document.write(JSON.stringify(d3err));
                        }
                        else {
                            //alert("d3SUCCESS", JSON.stringify(d3data));
                            var myvar = d3data;
                            MakeSummary(myvar.hits)
                        }
                    });
                }

            }

        function fail(error) {
            alert("An error has occurred: Code = " + error.code
            + " upload error source " + error.source
            + " upload error target " + error.target);
            alert(JSON.stringify(error));
        }

        function MakeUrlList(urldata) {
            document.getElementById("urlsTabStartMessage").style.display = "none";
            resetSummary();
            var urlArray = urldata.split(",");
            var urls = d3.select('#urlsTab')
                    .selectAll("span")
                    .data(urlArray)
                    .enter();

            var urlItem = urls.append("p")
                    .attr("class", "urlListItem")
                    .text(function(d, i) {
                        return (i+1)+". "+d;
                    });

            function resetSummary() {
                d3.selectAll("span").remove();
                d3.selectAll(".urlListItem").remove();
            }

        }

        function MakeSummary(myVariantHitsArray) {

            if (typeof(myVariantHitsArray) === "undefined") {
                navigator.notification.alert(
                    "No variants were recognized in the poster. Remember, EXPLANe only recognizes RSIDs!",
                    function() { console.log("no variants found");},
                    "EXPLANe",
                    "OKAY"
                )
            }

            function verifyClinicalStatus(item){
                if(item.hasOwnProperty("clinvar")) {
                    if(item.clinvar.hasOwnProperty("clinical_significance")) {
                        return "This variant is known to be clincally "+item.clinvar.clinical_significance+" (clinvar)";
                    }
                    else {
                        return "No data found about clinical relevance";
                    }
                }
                else {
                    return "No data found about clinical relevance";
                }
            }

            function verifyPhenotypicRelevance(item){
                if(item.hasOwnProperty("grasp")) {
                    if(item.grasp.hasOwnProperty("publication")) {
                        var phenotypes = [];
                        item.grasp.publication.forEach(function(pubdetails) {
                            if(pubdetails.hasOwnProperty("phenotype")) {
                                phenotypes.push(pubdetails.phenotype);
                            }
                            else {
                                console.log("no phenotype field")
                            }
                        });
                        return "This variant is associated with literature on "+formatArray(phenotypes)+" (grasp)";
                    }
                    else {
                        return "No data found about phenotype";
                    }
                }
                else {
                    return "No data found about phenotype";
                }
            }

            function verifyGenes(item){
                // clinvar.gene.symbol
                // wellderly.gene
                if(item.hasOwnProperty("clinvar")) {
                    if(item.clinvar.hasOwnProperty("gene")) {
                        if(item.clinvar.gene.hasOwnProperty("symbol")) {
                            return "This variant is associated with "+item.clinvar.gene.symbol+" (clinvar)";
                        }
                        else {
                            return "No data found on gene";
                        }
                    }
                    else {
                        return "No data found on gene";
                    }
                }
                else if(item.hasOwnProperty("wellderly")) {
                    if(item.wellderly.hasOwnProperty("gene")) {
                        return "This variant is associated with the gene(s): "+formatArray(item.wellderly.gene)+" (wellderly)";
                    }
                    else {
                        return "No data found on gene";
                    }
                }
                else {
                    return "No data found on gene";
                }
            }

            function verifyAlleles(item) {
                if(item.hasOwnProperty("wellderly")) {
                    if(item.wellderly.hasOwnProperty("alleles")) {
                        var temp = item.wellderly.alleles;
                        temp.push("wellderly");
                        return temp;
                    }
                }
                else {
                    return [
                        {
                            "allele": "N",
                            "freq": 0
                        },
                        {
                            "allele": "N",
                            "freq": 0
                        }
                    ];
                }
            }


            function verifyRSID(item){
                if(item.hasOwnProperty("clinvar")) {
                    if(item.clinvar.hasOwnProperty("rsid")) {
                        return "This variant also has the RSID: "+item.clinvar.rsid+" (clinvar)";
                    }
                    else {
                        return "No data found on RSID";
                    }
                }
                else if(item.hasOwnProperty("dbsnp")) {
                    if(item.dbsnp.hasOwnProperty("rsid")) {
                        return "This variant also has the RSID: "+item.dbsnp.rsid+" (dbsnp)";
                    }
                    else {
                        return "No data found on RSID";
                    }
                }
                else {
                    return "No data found on RSID";
                }
            }

            function formatArray(arr){
                var outStr = "";
                if (arr.length === 1) {
                    outStr = arr[0];
                } else if (arr.length === 2) {
                    //joins all with "and" but no commas
                    //example: "bob and sam"
                    outStr = arr.join(' and ');
                } else if (arr.length > 2) {
                    //joins all with commas, but last one gets ", and" (oxford comma!)
                    //example: "bob, joe, and sam"
                    outStr = arr.slice(0, -1).join(', ') + ', and ' + arr.slice(-1);
                }
                return outStr;
            }

            document.getElementsByClassName("event received")[0].innerHTML = "Status: Summarizing";

            var margin = {top: 10,
                bottom: 10,
                left: 30,
                right:30};

            var width = window.innerWidth - margin.right - margin.left; //was 400
            var height = window.innerHeight - margin.top - margin.bottom;

            function resetSummary() {
                d3.selectAll("span").remove();
                d3.selectAll("h1").remove();
                d3.selectAll("h4").remove();
                d3.selectAll(".chart").remove();
                d3.selectAll("hr").remove();
            }

            resetSummary();

            var leadItem = d3.select('#geneticsTab')
                    .selectAll("span")
                    .data(function() {
                        if (typeof(myVariantHitsArray) === "undefined") {
                            //resetSummary();
                            return [];
                        }
                        else {
                            return myVariantHitsArray;
                        }
                    })
                    .enter();

            var resultsTitle = d3.select("#resultsTitle")
                    .style("display", "inline")
                    .html(function() {
                        if (typeof(myVariantHitsArray) === "undefined") {
                            return "No variants were found<br><br>";
                        }
                        else {
                            return myVariantHitsArray.length+" variant(s) were found:<br><br>";
                        }
                    });

            var variantTitle = leadItem
                    .append("h1")
                    .attr("class", function(d) {
                        return d._id+" title";
                    }).html(function(d) {
                        return d._id;
                    });

            var textRSID = leadItem.append("h4")
                    .html(function(d) {
                        return verifyRSID(d);
                    });

            var textClinicalSignif = leadItem.append("h4")
                    .html(function(d) {
                        return verifyClinicalStatus(d);
                    });

            var textPhenotypicRelevance = leadItem.append("h4")
                    .html(function(d) {
                        return verifyPhenotypicRelevance(d);
                    });

            var genes = leadItem.append("h4")
                    .html(function(d) {
                        return verifyGenes(d);
                    });


            // Bar graph below
            var barHeight = 30+'px';

            var x = d3.scale.linear()
                    .domain([0, 1])
                    .range([0, 85]);

            var bar = leadItem.append("div")
                    .attr("class", "chart");
                    // .style("margin-left", "150px")
                    // .style("margin-right", "150px");

            bar.append("span")
                    .text(function(d) {
                        if(typeof(verifyAlleles(d)[2]) !== "undefined") {
                            return "Allele Frequencies ("+verifyAlleles(d)[2]+"):";
                        }
                        else {
                            return "No allele frequency data found";
                        }
                    });

            // top bar
            var topbar = bar.append("div")
                    .attr("class", "topbar");

            var topbarText = topbar.append("div")
                    .attr("class", "topbartext")
                    .style("color", "black")
                    .style("width", "5%")
                    .style("height", "50%")
                    .text(function(d) {
                        if (verifyAlleles(d)[0].allele === "N") {
                            return "";
                        }
                        else {
                            return verifyAlleles(d)[0].allele;
                        }
                    })
                    .style("float", "left")
                    .style("line-height", barHeight);

            var topbarBar = topbar.append("div")
                    .attr("class", "topbarbar")
                    .style("width", function(d) {
                        if (verifyAlleles(d)[0].allele === "N" & verifyAlleles(d)[0].freq === 0) {
                            return "0%";
                        }
                        else {
                            return x(verifyAlleles(d)[0].freq)+"%";
                        }
                    })
                    .style("height", barHeight)
                    .style("background-color", function(d) {
                        if (verifyAlleles(d)[0].allele === "N" & verifyAlleles(d)[0].freq === 0) {
                            return "";
                        }
                        else {
                            return "#0099CC";
                        }
                    })
                    .style("float","left");

            var topbarNumber = topbar.append("div")
                    .attr("class", "topbarnumber")
                    .style("width", function(d) {
                        return (85-x(verifyAlleles(d)[0].freq))+"%";
                    })
                    .style("height", "50%")
                    .text(function(d) {
                        if (verifyAlleles(d)[0].allele === "N" & verifyAlleles(d)[0].freq === 0) {
                            return "";
                        }
                        else {
                            return verifyAlleles(d)[0].freq.toFixed(2);
                        }
                    })
                    .style("color", "black")
                    .style("float", "left")
                    .style("line-height", barHeight);

            // bottom bar
            var bottombar = bar.append("div")
                    .attr("class", "bottombar")
                    .style("clear", "both");

            var bottombarText = bottombar.append("div")
                    .attr("class", "topbartext")
                    .style("color", "black")
                    .style("width", "5%")
                    .text(function(d) {
                        if (verifyAlleles(d)[0].allele === "N") {
                            return "";
                        }
                        else {
                            return verifyAlleles(d)[1].allele;
                        }
                    })
                    .style("float", "left")
                    .style("line-height", barHeight);

            var bottombarBar = bottombar.append("div")
                    .attr("class", "topbarbar")
                    .style("width", function(d) {
                        if (verifyAlleles(d)[1].allele === "N" & verifyAlleles(d)[1].freq === 0) {
                            return "0%";
                        }
                        else {
                            return x(verifyAlleles(d)[1].freq)+"%";
                        }
                    })
                    .style("height", barHeight)
                    .style("background-color", function(d) {
                        if (verifyAlleles(d)[1].allele === "N" & verifyAlleles(d)[1].freq === 0) {
                            return "";
                        }
                        else {
                            return "#CD6600";
                        }
                    })
                    .style("float","left");

            var bottombarNumber = bottombar.append("div")
                    .attr("class", "topbarnumber")
                    .style("width", function(d) {
                        if (verifyAlleles(d)[1].allele === "N" & verifyAlleles(d)[1].freq === 0) {
                            return "0%";
                        }
                        else {
                            return (85-x(verifyAlleles(d)[1].freq))+"%";
                        }
                    })
                    .text(function(d) {
                        if (verifyAlleles(d)[1].allele === "N" & verifyAlleles(d)[1].freq === 0) {
                            return "";
                        }
                        else {
                            return verifyAlleles(d)[1].freq.toFixed(2);
                        }
                    })
                    .style("color", "black")
                    .style("float", "left")
                    .style("line-height", barHeight);


            var textBreak = leadItem.append("hr").style("clear", "both");


            document.getElementsByClassName("event received")[0].innerHTML = "Status: Query Complete";

        }



// Setup status update to notify user of where in the process they are.            
// myvar.hits.forEach(function(n) {console.log(Object.keys(n));});
// Next update: use HTML instead of SVG. No text wrap in SVG and bars can be 
// created with div tags.


        </script>
    </body>
</html>

